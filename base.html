<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Map</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;800&family=Roboto&display=swap" rel="stylesheet">
	<!-- Стили для календаря -->
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
	<body>	
		<div class="canvas_container">
			<div class="canvas"></div>
				<div class="bg-sharebuttons">
					<div class="canvas_text">SHARE</div>
					<img src="{{ url_for('static', filename='css/img/exit.png') }}" alt="back" class="back" onclick="canvas_back()">
					<div class="ya-share2" data-curtain data-size="l" data-shape="round" data-lang="en" data-services="vkontakte,facebook,telegram,twitter,reddit">	
				</div>
			</div>
		</div>
		<header class="header">	
			<div class="container_header">
				<div class="header_inner">
					<a href="/home" class="href_logo">
						<div class="logo_div">
							<div class="logo" id='logo'></div>
							<img src="{{ url_for('static', filename='css/img/vector_logo.png') }}" class="img_logo">
							<div class="logo_div_text">
								<div class="logo_up">MAP STATISTICS</div>
								<div class="logo_down">gradient vizualization</div>
							</div>
						</div>
					</a>
					<nav class="nav">
						<a href="/home" class="nav_link">home</a>
						<a href="/about-us" class="nav_link">about us</a>
						<a href="/contacts" class="nav_link">news</a>
						<a href="/coronavirus" class="nav_link" id="coronavirus_nav">coronavirus</a>
					</nav>
					<div class="language_con">
						<img src="{{ url_for('static', filename='css/img/translate.png') }}" class="translate_icon">
					</div>

				</div>
			</div>
		</header>
		<div class="intro">
			<div class="container_intro">
				{% block content %}{% endblock %}
			</div>
		</div>
		<div class="footer">
			<div class="container_footer">
				<div class="text_footer">© 2020 All Rights Reserved.</div>
			</div>
		</div>
    	<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.8/datamaps.all.js"></script>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<!-- Скрипт для кнопок "поделиться" -->
		<script src="https://yastatic.net/share2/share.js"></script> 
		<!--  Скрипты для календаря  -->
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	    <script type="text/javascript">
	    	//var title_of_type_arr = {'population': ['Country', 'Population'], 'death': ['Country', 'Death rate/1,000 persons']}
	    	var region_codes = {"015": 'Northern Africa', "011": 'Western Africa', "017": 'Middle Africa', "014": 'Eastern Africa', "018": 'Southern Africa', "154": 'Northern Europe', "155": 'Western Europe', "151": 'Eastern Europe', "039": 'Southern Europe', "021": ' Northern America', "029": 'Caribbean', "013": 'Central America', "005": 'South America', "143": 'Central Asia', "030": 'Eastern Asia', "034": 'Southern Asia', "035": 'South-Eastern Asia', "145": 'Western Asia', "053": 'Australia and New Zealand', "054": 'Melanesia', "057": 'Micronesia', "061": 'Polynesia'}
	    	// var region_with_countries = [
	    	// // 002 - Africa
	    	// 	['015', 'Algeria', 'Egypt', 'Western Sahara', 'Libya', 'Morocco', 'Sudan', 'South Sudan', 'Tunisia'],
	    	//  	['011', 'Burkina Faso', 'Benin', "Côte d'Ivoire", 'Cabo Verde', 'Ghana', 'Gambia', 'Guinea', 'Guinea-Bissau', 'Mali', 'Mauritania', 'Niger', 'Nigeria',
	    	//  	 'Saint Helena, Ascension and Tristan da Cunha', 'Sierra Leone', 'Senegal', 'Togo'],
	    	//  	['017', 'Angola', 'CD', 'Zaire', 'Central African Republic', 'Congo', 'Cameroon', 'Gabon', 'Equatorial Guinea', 'Sao Tome and Principe', 'Chad'],
	    	//  	['014', 'Burundi', 'Djibouti', 'Eritrea', 'Ethiopia', 'Kenya', 'Comoros', 'Madagascar', 'Mauritius', 'Malawi', 'Mozambique', 'Réunion', 'Rwanda', 'Seychelles', 'Somalia', 'TZ', 'Uganda', 
	    	//  	 'Mayotte', 'Zambia', 'Zimbabwe'],
	    	//  	['018', 'Botswana', 'Lesotho', 'Namibia', 'Eswatini', 'South Africa'],
	    	// //  150 - Europe
	    	// 	['154', 'Guernsey', 'Jersey', 'Åland Islands', 'Denmark', 'Estonia', 'Findland', 'Faroe Islands', 'United Kingdom of Great Britain and Northern Ireland', 'Ireland', 'Isle of Man', 'Iceland', 'Lithuania', 'Latvia', 'Norway', 'Sweden', 'Svalbard and Jan Mayen'],
	    	// 	['155', 'Austria', 'Belgium', 'Switzerland', 'Germany', 'France', 'Liechtenstein', 'Luxembourg', 'Monaco', 'Netherlands'],
	    	// 	['151', 'Bulgaria', 'Belarus', 'Czechia', 'Hungary', 'Moldova, Republic of', 'Poland', 'Romania', 'Russian Federation', 'Slovakia', 'Ukraine'],
	    	// 	['039', 'Andorra', 'Albania', 'Bosnia and Herzegovina', 'Spain', 'Gibraltar', 'Greece', 'Croatia', 'Italy', 'Montenegro', 'North Macedonia', 'Malta', 'Serbia', 'Portugal', 'Slovenia', 'San Marino', 'Holy See', 'Yugoslavia'],
	    	// //	019 - Americas
	    	// 	['021', 'Bermuda', 'Canada', 'Greenland', 'Saint Pierre and Miquelon', 'United States'],
	    	// 	['029', 'Antigua and Barbuda', 'Anguilla', 'Aruba', 'Barbados', 'Saint Barthélemy', 'Bahamas', 'Cuba', 'Dominica', 'Dominican Republic', 'Grenada', 'Guadeloupe', 'Haiti', 'Jamaica', 'Saint Kitts and Nevis', 'Cayman Islands', 'Saint Lucia', 'Saint Martin (French part)', 'Martinique', 'Montserrat', 'Puerto Rico', 'Turks and Caicos Islands', 'Trinidad and Tobago', 'Saint Vincent and the Grenadines', 'Virgin Islands (British)', 'United States Minor Outlying Islands'],
	    	// 	['013', 'Belize', 'Costa Rica', 'Guatemala', 'Honduras', 'Mexico', 'Nicaragua', 'Panama', 'El Salvador'],
	    	// 	['005', 'Argentina', 'Bolivia (Plurinational State of)', 'Brazil', 'Chile', 'Colombia', 'Ecuador', 'Falkland Islands (Malvinas)', 'French Guiana', 'Guyana', 'Peru', 'Paraguay', 'Suriname', 'Uruguay', 'Venezuela (Bolivarian Republic of)'],
	    	// // 142 - Asia
	    	// 	['143', 'Turkmenistan', 'Tajikistan', 'Kyrgyzstan', 'Kazakhstan', 'Uzbekistan'],
	    	// 	['030', 'China', 'Hong Kong', 'Japan', "Korea (Democratic People's Republic of)", 'Korea, Republic of', 'Mongolia', 'Macao', 'Taiwan, Province of China'],
	    	// 	['034', 'Afghanistan', 'Bangladesh', 'Bhutan', 'India', 'Iran (Islamic Republic of)', 'Sri Lanka', 'Maldives', 'Nepal', 'Pakistan'],
	    	// 	['035', 'Brunei Darussalam', 'Indonesia', 'Cambodia', "Lao People's Democratic Republic", 'Myanmar', 'Burma', 'Malaysia', 'Philippines', 'Singapore', 'Thailand', 'Timor-Leste', 'East Timor', 'Viet Nam'],
	    	// 	['145', "United Arab Emirates", "Armenia", "Azerbaijan", "Bahrain", "Cyprus", "Georgia", "Israel", "Iraq", "Jordan", "Kuwait", "Lebanon", "Oman", "Palestine, State of", "Qatar", "Saudi Arabia", "Syrian Arab Republic", "Turkey", "Yemen"],
	    	// // 009 - Oceania
	    	// 	['053', 'Australia', 'Norfolk Island', 'New Zealand'],
	    	// 	['054', 'Fiji', 'New Caledonia', 'Papua New Guinea', 'Solomon Islands', 'Vanuatu'],
	    	// 	['057', 'Micronesia (Federated States of)', 'Guam', 'Kiribati', 'Marshall Islands', 'Northern Mariana Islands', 'Nauru', 'Palau'],
	    	// 	['061', 'American Samoa', 'Cook Islands', 'Niue', 'French Polynesia', 'Pitcairn', 'Tokelau', 'Tonga', 'Tuvalu', 'Wallis and Futuna', 'Samoa']
	    	// ];
	    	var random_gradient_arr = [['#FF35EB', '#1E27FF'], ['#4DFFDF', '#FF1CBF'], ['#11C6FF', '#FFF500'], ['#FF1E1E', '#0060F1'], ['#54FF18', '#2E0CFF'], ['#FF1E6F', '#EFFF35'], ['#D7FF35', '#FF1E1E'], ['#88C606', '#FFD028', '#FF35EB']]
	    	var not_country = ['1A', 'S3', 'B8', 'V2', 'Z4', '4E', 'T4', 'XC', 'Z7', '7E', 'T7', 'EU', 'F1', 'XE', 'XD', 'XF', 'ZT', 'XH', 'XI', 'XG', 'V3', 'ZJ', 'XJ', 'T2', 'XL', 'XO', 'XM', 'XN', 'ZQ', 'XQ', 'T3', 'XP', 'XU', 'XY', 'OE', 'S4', 'S2', 'V4', 'V1', 'S1', '8S', 'T5', 'ZG', 'ZF', 'T6', 'XT', '1W'] // 1W - WORLD

	    	var covid_categories_old = ['Cases', 'Today Cases', 'Deaths', 'Today Deaths', 'Recovered', 'Today Recovered', 'Active', 'Critical', 'Cases Per One Million', 'Deaths Per One Million', 'Tests', 'Tests Per One Million', 'One Case Per People', 'One Death Per People', 'One Test Per People', 'Active Per One Million', 'Recovered Per One Million', 'Critical Per One Million']
	    	covid_categories_old.sort()
	    	var covid_data_for_today = ['Total cases for today', 'New cases for today', 'Total deaths for today', 'New deaths for today', 'Total recovered cases for today', 'New recovered cases for today', 'Total active cases for today', 'Total serious/critical cases for today', 'Total tests performed for today', 'Total cases per one million for today', 'Total deaths per one million for today', 'Total recovered per one million for today', 'Total active cases per one million for today', 'Total serious/critical cases per one million for today', 'Total tests performed per one million for today']
	    	//covid_data_for_today.sort()
	    	var covid_historical_data = ['Total cases for current date', 'New cases for current date', 'Total deaths for current date', 'New deaths for current date', 'Total recovered cases for current date', 'New recovered cases for current date']
	    	//covid_historical_data.sort()
	    	var covid_categories_longest = {'Total cases for today': 'cases', 'New cases for today': 'todayCases', 'Total deaths for today': 'deaths', 'New deaths for today': 'todayDeaths', 'Total recovered cases for today': 'recovered', 'New recovered cases for today': 'todayRecovered', 'Total active cases for today': 'active', 'Total serious/critical cases for today': 'critical', 'Total tests performed for today': 'tests', 'Total cases per one million for today': 'casesPerOneMillion', 'Total deaths per one million for today': 'deathsPerOneMillion', 'Total recovered per one million for today': 'recoveredPerOneMillion', 'Total active cases per one million for today': 'activePerOneMillion', 'Total serious/critical cases per one million for today': 'criticalPerOneMillion', 'Total tests performed per one million for today': 'testsPerOneMillion',	'Total cases for current date': "cases", 'New cases for current date': 'cases', 'Total deaths for current date': 'deaths', 'New deaths for current date': 'deaths', 'Total recovered cases for current date': 'recovered', 'New recovered cases for current date': 'recovered'
	    }

	    	let not_displayed_countries = ['ABW', 'AIA', 'ALA', 'ASM', 'ATA', 'ATF', 'ATG', 'AND', 'BES', 'BHR', 'BLM', 'BRB', 'BVT', 'CCK', 'COK', 'COM', 'CPV', 'CUW', 'CXR', 'CYM', 'DMA', 'FRO', 'FSM', 'GGY', 'GIB', 'GLP', 'GRD', 'GUM', 'HKG', 'HMD', 'IMN', 'IOT', 'JEY', 'KIR', 'KNA', 'LCA', 'LIE', 'MAC', 'MAF', 'MDV', 'MHL', 'MLT', 'MNP', 'MSR', 'MTQ', 'MUS', 'MYT', 'NFK', 'NIU', 'NRU', 'PCN', 'PLW', 'PSE', 'PYF', 'REU', 'SGP', 'SGS', 'SJM', 'SHN', 'SPM', 'STP', 'SXM', 'SYC', 'TCA', 'TKL', 'TON', 'TUV', 'UMI', 'VAT', 'VCT', 'VGB', 'VIR', 'WLF', 'WSM', 'SMR']// массив стран, которые не отображаюся на карте в силу их масштаба
	    	var covid_data;
	    	var historical_covid_data;
	    	var JHUCSSE_data;
	    	var JHUCSSE_data_dict = {};
	    	var dict_country_iso3 = {};
	    	var dict_country_iso3_history = {};
	    	var dict_country_iso3_history_previous = {};

	    	var date = new Date();
	    	var year = date.getFullYear();
    		var month = date.getMonth()+1
    		var day = date.getDate()
    		var previous_day = day - 1

	    	var min_date_covid = new Date(2020, 0, 23);
	    	var max_date_covid = date.setHours(0, 0, 0, 0); // Сегоднешний день с 00:00 по времени
	    	var previous_date = new Date(date.setHours(0, 0, 0, 0)-86400000)
	    	// console.log(new Date(max_date_covid-86400000));
	    	// console.log((max_date_covid-min_date_covid) / (3600*1000*24));
	    	// console.log(307*(3600*1000*24)+min_date_covid); //max_date_covid
	    	var max_date_datepicker;
	    	var previous_max_date_datepicker;
	    	
	    	

	    	//Создание МЕНЮ:
	    	var letters = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'l', 'm', 'n', 'o', 'p', 'r', 's', 't', 'u', 'v', 'w', 'y']
	    	var accordion = document.getElementsByClassName('accordion');
	    	var our_parent = document.getElementById('categories_inner_inner');
	    	var num_over_slider = document.getElementById("num_over_slider");
	    	var slider = document.getElementById("slider");
	    	var slider_loader = document.getElementById("slider_loader");
	    	var min_num = document.getElementById("min_num");
			var max_num = document.getElementById("max_num");
			var title_category = document.getElementsByClassName('title_category')[0]
			var title_region = document.getElementsByClassName('title_region')[0]
			var title_region_span = document.getElementsByClassName('title_region_span')[0]


			{% if category|safe %}
				var category = {{ category|safe }};
			{% else %}
	    		var category = 'none'
	    	{% endif %}		
	    	console.log(category);


	    	{% if alldata|safe %}
	    		var alldata = {{ alldata|safe }};
	    	{% else %}
	    		var alldata = 'none'
	    	{% endif %}	


	    	{% if ctg_and_indicator|safe %}
	    		var ctg_and_indicator = {{ ctg_and_indicator|safe }};
	    	{% else %}
	    		var ctg_and_indicator = 'none';
	    	{% endif %}
	    	console.log(ctg_and_indicator);
	    	
	    	var length_scroll = 100;
	    	var data_alphabet_all = []
	    	var arr_for_data = []
	    	var indicator = ''
	    	var indicator_for_history;
	    	var dataset = []
	    	var id = ""
	    	var slider_ready = 0;
	    	var x_lad;
	    	var iff = 1;
	    	var indicator_random_bttn
	    	
	    
	    	var map = document.getElementById('map_container');
	    	var load_circle = document.getElementById('loader');
	    	var arr_for_data_copy;
	    	var arr_for_data_copy_covid;
	    	var datepicker = document.getElementById('datepicker')
	    	var slider_container = document.getElementById('slider_container')
	    	var buttons_container = document.getElementById('buttons_container')
	    	var categories_bg = document.getElementsByClassName('category_bg')

	    	num_over_slider.innerHTML = year
	    	slider.max = year
	    	slider.value = year
	    	max_num.innerHTML = year

	    	// Генерация рандомного числа.
	    	function getRandomInt(max) {
				return Math.floor(Math.random() * Math.floor(max));
			}
			var random_gradient = getRandomInt(random_gradient_arr.length)
			//console.log(random_gradient);

	    	GET_covid()
	    	create_menu()
	    	//set_random_gradient_arr()
	    	// ЗАГРУЗКА РАНДОМНОЙ КАТЕГОРИИ И СООТВЕТСВЕННО РАНДОМНОГО ЦВЕТА
	    	if(category != 'coronavirus' && ctg_and_indicator == 'none'){
	    		random_category()
	    	}
	    	
	    	// Функция печати для кнопки
	    	function print_dw(){
	    		print()
	    	}

	    	// Функция закрытия кнопок "поделиться"
	    	function canvas_back(){
	    		let canvas_container = document.getElementsByClassName('canvas_container')[0]
	    		canvas_container.style.display = "none"
	    	}
	    	// Поделиться
	    	function share(){
				let canvas_container = document.getElementsByClassName('canvas_container')[0]
				let canvas = document.getElementsByClassName('canvas')[0]
				canvas_container.style.display = "block"
				canvas.style.opacity = "80%"
	    	}
			// Делается рандомный градиент при загрузке страницы, ну а так это просто функция, которая генерирует и ставит рандомный градиент
	    	function set_random_gradient_arr(){
	    		let elems = ['logo', 'change_colour_bg', 'random_category', 'data']

	 
				// Если кол-во цветов в массиве == 3, то есть градиент состоит из трех цветов, то:
				for (let elem of elems) {
					if(random_gradient_arr[random_gradient].length == 3){
						$('#'+elem).css({
					   	 background: 'linear-gradient(90deg, '+random_gradient_arr[random_gradient][0]+', '+random_gradient_arr[random_gradient][1]+', '+random_gradient_arr[random_gradient][2]+')'
						});
					}else{
						$('#'+elem).css({
					   		background: 'linear-gradient(90deg, '+random_gradient_arr[random_gradient][0]+', '+random_gradient_arr[random_gradient][1]+')'
						});
					}
				}
				// Покраска "coronavirus" в крайний левый цвет градиента
				$('#coronavirus_nav').css({
			   	 color: random_gradient_arr[random_gradient][0]
				});
	    	}

	    	function create_menu(){	
	    		let category_bg = document.getElementsByClassName('category_bg')[0]
	    		let category_main = document.getElementsByClassName('category_main')[0]
	    		let select_tab = document.getElementsByClassName('select_tab')[0]
	    		let letters_for_search = document.getElementsByClassName('letters_for_search')[0]
	    		let under_the_letters_line = document.getElementsByClassName('under_the_letters_line')[0]
	    		let options_tab = document.getElementsByClassName('option_tab')
	    		let categories_text = document.getElementsByClassName('categories_text')[0]
	    		let categories = document.getElementsByClassName('categories')[0]  // Блок меню
	    		let bg_for_search_inner_container = document.getElementsByClassName('bg_for_search_inner_container')[0]  // Блок меню
	    		// Создание категории Ковида
	    		if(Object.keys(category).length != 1){ // Если кол-во ключей в category == 1, то удаляется covid (Если запрос про другой индикатор, то ковид удаляется)
		    		let select_tab_covid = document.getElementById('select_tab_covid')
		    		if(category != 'coronavirus'){
			    		// Создание заголовка DATA FOR TODAY
			    		let option_tab = document.createElement('div');
			    		option_tab.className = "option_tab_title"
			    		option_tab.value = ""
			    		option_tab.innerHTML = '----------- DATA FOR TODAY -----------'
			    		select_tab_covid.appendChild(option_tab);
			    		// Конец создания заголовка DATA FOR TODAY
			    	}else{
			    		category_bg.remove() // Удаления div'a covid-19, который мы создаем через home.html
			    		just_div = document.getElementsByClassName('category_main')[0].parentElement
			    		category_bg = document.createElement('div');
			    		category_bg.className = 'category_bg';
			    		category_bg.addEventListener('click', menu)
			    		just_div.appendChild(category_bg);

			    		triangle = document.createElement('div');
		    			triangle.className = 'triangle_less_open';
		    			category_bg.appendChild(triangle);

		    			category_text = document.createElement('div');
			    		category_text.className = 'category_text_less';
			    		category_text.innerHTML = 'DATA FOR TODAY'
			    		category_bg.appendChild(category_text);

			    		// Меняем местами два элемента (дива)
			    		let temporary_category_main = document.getElementsByClassName('category_main')[0]
			    		temporary_category_main.style.display = 'block'
			    		temporary_category_main.remove()
			    		category_bg.parentElement.appendChild(temporary_category_main)
			    	}

		    		// Создание option_tab'ов из массива covid_data_for_today
		    		for (let i = 0; i < covid_data_for_today.length; i++) {	
		    			option_tab = document.createElement('div');
		    			option_tab.className = "option_tab"
		    			option_tab.id = 'covid'
		    			option_tab.value = ""
		    			option_tab.innerHTML = covid_data_for_today[i]
		    			
		    			option_tab.addEventListener('click', click_data_covid)
		    			select_tab_covid.appendChild(option_tab);
		    			data_alphabet_all.push([covid_data_for_today[i], 'covid'])	// Добавляем в массив поиска данные по ковиду
		    		}
		    		if(category != 'coronavirus'){
			    		// Создание заголовка HISTORICAL DATA
			    		option_tab = document.createElement('div');
			    		option_tab.className = "option_tab_title"
			    		option_tab.value = ""
			    		option_tab.innerHTML = '----------- HISTORICAL DATA -----------'
			    		select_tab_covid.appendChild(option_tab);
			    		// Конец создания заголовка HISTORICAL DATA
			    	}else{
			    		just_div = document.createElement('div');
			    		our_parent.appendChild(just_div);

			    		category_bg = document.createElement('div');
			    		category_bg.className = 'category_bg';
			    		category_bg.addEventListener('click', menu)
			    		just_div.appendChild(category_bg);

			    		triangle = document.createElement('div');
		    			triangle.className = 'triangle_less';
		    			category_bg.appendChild(triangle);

		    			category_text = document.createElement('div');
			    		category_text.className = 'category_text_less';
			    		category_text.innerHTML = 'HISTORICAL DATA'
			    		category_bg.appendChild(category_text);

			    		// Создание category_main
			    		category_main = document.createElement('div');
			    		category_main.className = 'category_main';
			    		category_main.style.display = 'none'
			    		just_div.appendChild(category_main);

			    		// Создание under_the_letters_line
			    		under_the_letters_line = document.createElement('hr');
			    		under_the_letters_line.className = 'under_the_letters_line';
			    		category_main.appendChild(under_the_letters_line);

			    		// Создание select_tab
			    		select_tab = document.createElement('div');
			    		select_tab.className = "select_tab"
			    		select_tab.id = "select_tab"
			    		select_tab.size = 3
			    		category_main.appendChild(select_tab);
			    		
			    	}

		    		// Создание option_tab'ов из массива covid_historical_data
		    		for (let i = 0; i < covid_historical_data.length; i++) {	
		    			option_tab = document.createElement('div');
		    			option_tab.className = "option_tab"
		    			option_tab.id = 'covid'
		    			option_tab.value = ""
		    			option_tab.innerHTML = covid_historical_data[i]
		    			
		    			option_tab.addEventListener('click', click_data_covid)
		    			select_tab.appendChild(option_tab);
		    			data_alphabet_all.push([covid_historical_data[i], 'covid'])	// Добавляем в массив поиска данные по ковиду
		    		}
		    		
		    	}else{
					our_parent.firstElementChild.remove()	// Удаляется див с коронавирусом в меню
		    	}
	    		// Конец создания категории Ковида

	    		// Создание категорий World banka
	    		if (category != 'coronavirus'){  // Если url не равен coronavirus, то создаются категории world banka
			    	for (let i = 1; i < Object.keys(category).length+1; i++) { // длина ключей словаря "category"
			    		data_alphabet = []
			    		length_scroll += 49;
			    		just_div = document.createElement('div');
			    		our_parent.appendChild(just_div);

			    		category_bg = document.createElement('div');
			    		category_bg.className = 'category_bg';
			    		category_bg.addEventListener('click', menu)
			    		just_div.appendChild(category_bg);

			    		if(category[Object.keys(category)[i-1]].length < 37){
							triangle = document.createElement('div');
			    			triangle.className = 'triangle_less';
			    			category_bg.appendChild(triangle);
			    		}else{
			    			div_triangle = document.createElement('div');
			    			div_triangle.className = 'div_triangle'
			    			category_bg.appendChild(div_triangle)

			    			triangle = document.createElement('div');
			    			triangle.className = 'triangle_much';
			    			div_triangle.appendChild(triangle);
			    		}
						

			    		category_text = document.createElement('div');
			    		
			    		category_text.innerHTML = category[Object.keys(category)[i-1]]
						if(category[Object.keys(category)[i-1]].length < 37){			// если длина строки меньше 45, то 
							category_text.className = 'category_text_less';
						}else{
							category_text.className = 'category_text_much';
						}
			    		
			    		
			    		category_bg.appendChild(category_text);

						category_main = document.createElement('div');
			    		category_main.className = 'category_main';
			    		just_div.appendChild(category_main);

			    		letters_for_search = document.createElement('div');
			    		letters_for_search.className = 'letters_for_search';
			    		category_main.appendChild(letters_for_search);

			    		for (let letter = 0; letter < letters.length; letter++) {
			    			search_for_letter = document.createElement('a');
			    			search_for_letter.className = 'search_for_letter'
			    			search_for_letter.innerHTML = letters[letter]
			    			search_for_letter.addEventListener('click', topscroll)
			    			letters_for_search.appendChild(search_for_letter);
			    			
			    		}

			    		under_the_letters_line = document.createElement('hr');
			    		under_the_letters_line.className = 'under_the_letters_line';
			    		category_main.appendChild(under_the_letters_line);

			    		// Создание select
			    		select_tab = document.createElement('div');
			    		select_tab.className = "select_tab"
			    		select_tab.id = "select_tab"
			    		select_tab.size = 3
			    		category_main.appendChild(select_tab);
			    		
			    		for (var op = 0; op < alldata[Object.keys(category)[i-1]].length; op++) {
			    			prearr = [alldata[Object.keys(category)[i-1]][op][1], alldata[Object.keys(category)[i-1]][op][0]]
			    			if(prearr[0][10] == ","){
			    				str_to_fix = prearr[0].split('')
			    				str_to_fix.splice(10, 1);
			    				prearr.splice(0, 1);
			    				prearr.unshift(str_to_fix.join(''))
			    			}
			    			data_alphabet.push(prearr)
			    			data_alphabet_all.push(prearr)
			    		}
			    		data_alphabet.sort()

			    		for (var alphabet = 0; alphabet < data_alphabet.length; alphabet++) {
			    			option_tab = document.createElement('div');
			    			option_tab.className = "option_tab"
			    			option_tab.id = data_alphabet[alphabet][1]
			    			option_tab.value = ""
			    			option_tab.innerHTML = data_alphabet[alphabet][0]
			    			
			    			option_tab.addEventListener('click', click_data)
			    			select_tab.appendChild(option_tab);
			    		}
			    	}
			    }else{		
			    	categories_text.innerHTML = category // categories_text заменяется на var category	    	
			    	for (let category_main of document.getElementsByClassName('category_main')) {	// Удаляется height у category_main
			    		category_main.style.height = "auto";		
			    	} 
			    	for (let select_tab of document.getElementsByClassName('select_tab')) {    // Удаляется height у select_tab
			    		select_tab.style.height = "auto";
			    	} 
		    		// select_tab.style.marginTop = '15px'
		    		//letters_for_search.remove()		// Удаляем "буквы поиска"
		    		// under_the_letters_line.remove()		// Удаляем "линию"
		    		// for(let option_tab of options_tab){	// перебор всех option tab и увелечение их размера
		    		// 	option_tab.style.fontSize = '14px'
		    		// 	option_tab.style.paddingLeft = '36px'
		    		// }
		    		// categories.style.width = '365px'
		    		// bg_for_search_inner_container.style.width = '344px'
		
			    }

			    if(ctg_and_indicator != 'none'){		// если идет запрос по адресу '/home/category/<ctg>/<indicator>', то перебираются блоки в меню
				    for(category_bg of categories_bg){	// и если нашелся такой же блок как и в запросе, то он открывается:
				    	if(category_bg.children[1].innerHTML.toLowerCase().split(" ").join("-") == ctg_and_indicator[0]){ 		// тут он в нижнем регистре и "пробел" заменен на "-"
				    		if(category_bg.children[0].className == 'div_triangle'){	// Если ребенок ctegory_bg.className = div_triangle, т.е. triangle_much, то
				    			category_bg.children[0].children[0].className = 'triangle_much_open'
				    		}else{
				    			category_bg.children[0].className = "triangle_" + category_bg.children[1].className.slice(-4) + '_open'
				    		}
				    		
				    		category_bg.nextElementSibling.style.display = 'block'
				    		for(let option_tab of category_bg.nextElementSibling.children[2].children){	// перебор детей у select_tab в меню
				    			if(ctg_and_indicator[0] == 'covid-19'){			// если в <ctg> написано 'covid-19', то поиск идет по innerHTML, если нет, то поиск идет по id элемента option_tab
				    				if(option_tab.innerHTML.toLowerCase().split(" ").join("-") == ctg_and_indicator[1]){ // Если при запросе у <covid-19> действительно есть такой <category>, то она загружается
				    					console.log(option_tab);
				    					setTimeout(click_data_covid, 2000);
				    				} 
				    			}else{ // Если при запросе у <ctg> действительно есть такой <category>, то она загружается
				    				if(option_tab.id == ctg_and_indicator[1]){
				    					id = ctg_and_indicator[1]
				    					click_data()
				    				}else{
				    					// wrong request
				    				}
				    			}
				    		}			    		
				    	}
				    }
				}
		    }

		    

		    // Получаем данные ковид из апи https://disease.sh/docs/#/
		    function GET_covid(){
		    	let wrong_name = [['UK', 'United Kingdom'], ['Macedonia', 'North Macedonia'], ['Taiwan', 'Taiwan*'], ["Lao People's Democratic Republic", 'Laos'], ['Syrian Arab Republic', 'Syria'], ['S. Korea', 'Korea, South'], ['Libyan Arab Jamahiriya', 'Libya'], ['Congo', 'Congo (Brazzaville)'], ['DRC', 'Congo (Kinshasa)'], ["Côte d'Ivoire", "Cote d'Ivoire"], ['UAE', 'United Arab Emirates'], ['Bosnia and Herzegovina', 'Bosnia and Herzegovina'], ['Bosnia', 'Bosnia and Herzegovina'], ['Swaziland', 'Eswatini'], ['Myanmar', 'Burma']]
		    	let wrong_name_previous = [["Cote d'Ivoire", "Côte d'Ivoire"], ['Libya', 'Libyan Arab Jamahiriya'], ['United Arab Emirates', 'UAE'], ['Democratic republic of congo', 'DRC'], ['Congo (Brazzaville)', 'Congo'], ['Congo (Kinshasa)', 'DRC'] ]
		    	let value;
		    	let x = new XMLHttpRequest();

	    		x.open("GET", "https://disease.sh/v3/covid-19/countries");
	    		x.send();
	    		x.onload = function() {    	
					let r = JSON.parse(x.response)
					covid_data = r

					console.log('covid_data');
					console.log(covid_data);
					for (let i = 0; i < r.length; i++) {
						if(r[i]['countryInfo']['iso3'] != null){
							if(r[i]['countryInfo']['iso3'] == 'PSE'){
								dict_country_iso3['West Bank and Gaza'] = r[i]['countryInfo']['iso3']
							}else{
								dict_country_iso3[r[i]['country']] = r[i]['countryInfo']['iso3']
							}
							
						}						
					}
					// Копируются данные из массива dict_country_iso3 в массив dict_country_iso3_history
					for (let key in dict_country_iso3) {
						dict_country_iso3_history[key] = dict_country_iso3[key]
					}
					// Копируются данные из массива dict_country_iso3 в массив dict_country_iso3_history_previous
					for (let key in dict_country_iso3) {	
						if(key == "Myanmar"){
							dict_country_iso3_history_previous['Burma'] = dict_country_iso3[key]
						}else{
							dict_country_iso3_history_previous[key] = dict_country_iso3[key]
						}
					}

					// 'UK' на 'United Kingdom', заменяем ключи на другие 
					for (let i = 0; i < wrong_name.length; i++) {
						value = dict_country_iso3_history[wrong_name[i][0]]
						delete dict_country_iso3_history[wrong_name[i][0]];
						dict_country_iso3_history[wrong_name[i][1]] = value
					}

				}

				let x2 = new XMLHttpRequest();

	    		x2.open("GET", "https://disease.sh/v3/covid-19/historical?lastdays=all");
	    		x2.send();
	    		x2.onload = function() {    	
					let r = JSON.parse(x2.response)
					historical_covid_data = r	
					console.log('historical_covid_data');
					console.log(historical_covid_data);		
				}

				let x3 = new XMLHttpRequest();
				let iff = 0
				let arr = []
				let keys = ['confirmed', 'deaths', 'recovered']
				let c = 0
				setTimeout(x3wait, 1000);
				function x3wait(){
		    		x3.open("GET", "https://disease.sh/v3/covid-19/jhucsse");
		    		x3.send();
		    		x3.onload = function() {    	
						let r = JSON.parse(x3.response)
						JHUCSSE_data = r		
						// Делаем более понятный словарь пример: 'cases': ['RU', 100]
						for (let key of keys) {
							arr = []
							pre_arr = []
							c = 0
							for (let i = 0; i < JHUCSSE_data.length; i++) {
								iff = 0
								for (let n = 0; n < arr.length; n++) { // Длина словаря (по ключам)
									// Если страна равна "определенной стране" и провинция равна "определенной провинции", то данные заносятся во временный массив, и в конце уже из него данные переходят в основной массив с [iso3code, value], например: ['NCL', 100].
									if(JHUCSSE_data[i]['country'] == 'United Kingdom' && JHUCSSE_data[i]['province'] == 'Falkland Islands (Malvinas)'){
										for (let p = 0; p < pre_arr.length; p++) {
											if(pre_arr[p][0] == dict_country_iso3_history['Falkland Islands (Malvinas)']){
												pre_arr.splice(p, 1)
											}
										}
										pre_arr.push([dict_country_iso3_history['Falkland Islands (Malvinas)'], JHUCSSE_data[i]['stats'][key]])
									}
									if(JHUCSSE_data[i]['country'] == 'France' && JHUCSSE_data[i]['province'] == 'New Caledonia'){
										for (let p = 0; p < pre_arr.length; p++) {
											if(pre_arr[p][0] == dict_country_iso3_history['New Caledonia']){
												pre_arr.splice(p, 1)
											}
										}
										pre_arr.push([dict_country_iso3_history['New Caledonia'], JHUCSSE_data[i]['stats'][key]])
									}else if(JHUCSSE_data[i]['country'] == 'France' && JHUCSSE_data[i]['province'] == 'French Guiana'){		// Почему тут else if, а в других местах if - понятия не имею, главное что работает :)
										for (let p = 0; p < pre_arr.length; p++) {
											if(pre_arr[p][0] == dict_country_iso3_history['French Guiana']){
												pre_arr.splice(p, 1)
											}
										}
										pre_arr.push([dict_country_iso3_history['French Guiana'], JHUCSSE_data[i]['stats'][key]])
									}
									if(JHUCSSE_data[i]['country'] == 'Denmark' && JHUCSSE_data[i]['province'] == 'Greenland'){
										for (let p = 0; p < pre_arr.length; p++) {
											if(pre_arr[p][0] == dict_country_iso3_history['Greenland']){
												pre_arr.splice(p, 1)
											}
										}
										pre_arr.push([dict_country_iso3_history['Greenland'], JHUCSSE_data[i]['stats'][key]])
									}

									if(arr[n][0] == dict_country_iso3_history[JHUCSSE_data[i]['country']]){
										c = arr[n][1]
										arr.splice(n, 1)
										c += JHUCSSE_data[i]['stats'][key]
										iff = 1
										arr.push([dict_country_iso3_history[JHUCSSE_data[i]['country']], c])
									}
								}
								if(!iff){
									arr.push([dict_country_iso3_history[JHUCSSE_data[i]['country']], JHUCSSE_data[i]['stats'][key]])
								}
							}
							// Вот тут вот данные переносятся из вспомогательного массива в основной.
							for (let p of pre_arr) {
								arr.push(p)
							}

							// Заносим в наш массив страну США из первого запроса, так как ее почему то нету в третьем запросе (JHUCSSE_data).
							for (let am = 0; am < covid_data.length; am++) {
								if(covid_data[am]['country'] == 'USA'){
									if(key == 'confirmed'){
										arr.push([covid_data[am]['country'], covid_data[am]['cases']])
									}else{
										arr.push([covid_data[am]['country'], covid_data[am][key]])
									}
									
								}							
							}
							
							
							// Если ключ равен, то он становится равен cases (т.к. в одном из двух запросов 'cases'(случаи заражения) = 'confirmed', а нам требуется 'cases', для обращения по ключу).
							if(key == 'confirmed'){
								JHUCSSE_data_dict['cases'] = arr
							}else{
								JHUCSSE_data_dict[key] = arr
							}
							
						}
						// ЗАГРУЗКА СРАЗУ CASES НА ВКЛАДКЕ КОРОНА
						if(category == 'coronavirus'){
    						click_data_covid()
    					}
						console.log('api done covid');
						console.log(JHUCSSE_data_dict)
						
					
					}
				}
		    }
	    	
	    	$('.categories_inner_inner').css('height',length_scroll+'px')

	    	// DATAMAP
	    	// DATAMAP
	    	// DATAMAP
	    	function Zoom(args) {
			  $.extend(this, {
			    $buttons:   $(".zoom-button"),
			    $info:      $("#zoom-info"),
			    scale:      { max: 50, currentShift: 0 },
			    $container: args.$container,
			    datamap:    args.datamap
			  });

			  this.init();
			}

			Zoom.prototype.init = function() {
			  var paths = this.datamap.svg.selectAll("path"),
			      subunits = this.datamap.svg.selectAll(".datamaps-subunit");

			  // preserve stroke thickness
			  paths.style("vector-effect", "non-scaling-stroke");

			  // disable click on drag end
			  subunits.call(
			    d3.behavior.drag().on("dragend", function() {
			      d3.event.sourceEvent.stopPropagation();
			    })
			  );

			  this.scale.set = this._getScalesArray();
			  this.d3Zoom = d3.behavior.zoom().scaleExtent([ 1, this.scale.max ]);

			  this._displayPercentage(1);
			  this.listen();
			};

			Zoom.prototype.listen = function() {
			  this.$buttons.off("click").on("click", this._handleClick.bind(this));

			  this.datamap.svg
			    .call(this.d3Zoom.on("zoom", this._handleScroll.bind(this)))
			    .on("dblclick.zoom", null); // disable zoom on double-click
			};

			Zoom.prototype.reset = function() {
			  this._shift("reset");
			};

			Zoom.prototype._handleScroll = function() {
			  var translate = d3.event.translate,
			      scale = d3.event.scale,
			      limited = this._bound(translate, scale);

			  this.scrolled = true;

			  this._update(limited.translate, limited.scale);
			};

			Zoom.prototype._handleClick = function(event) {
			  var direction = $(event.target).data("zoom");

			  this._shift(direction);
			};

			Zoom.prototype._shift = function(direction) {
			  var center = [ this.$container.width() / 2, this.$container.height() / 2 ],
			      translate = this.d3Zoom.translate(), translate0 = [], l = [],
			      view = {
			        x: translate[0],
			        y: translate[1],
			        k: this.d3Zoom.scale()
			      }, bounded;

			  translate0 = [
			    (center[0] - view.x) / view.k,
			    (center[1] - view.y) / view.k
			  ];

				if (direction == "reset") {
			  	view.k = 1;
			    this.scrolled = true;
			  } else {
			  	view.k = this._getNextScale(direction);
			  }

			l = [ translate0[0] * view.k + view.x, translate0[1] * view.k + view.y ];

			  view.x += center[0] - l[0];
			  view.y += center[1] - l[1];

			  bounded = this._bound([ view.x, view.y ], view.k);

			  this._animate(bounded.translate, bounded.scale);
			};

			Zoom.prototype._bound = function(translate, scale) {
			  var width = this.$container.width(),
			      height = this.$container.height();

			  translate[0] = Math.min(
			    (width / height)  * (scale - 1),
			    Math.max( width * (1 - scale), translate[0] )
			  );

			  translate[1] = Math.min(0, Math.max(height * (1 - scale), translate[1]));

			  return { translate: translate, scale: scale };
			};

			Zoom.prototype._update = function(translate, scale) {
			  this.d3Zoom
			    .translate(translate)
			    .scale(scale);

			  this.datamap.svg.selectAll("g")
			    .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

			  this._displayPercentage(scale);
			};

			Zoom.prototype._animate = function(translate, scale) {
			  var _this = this,
			      d3Zoom = this.d3Zoom;

			  d3.transition().duration(350).tween("zoom", function() {
			    var iTranslate = d3.interpolate(d3Zoom.translate(), translate),
			        iScale = d3.interpolate(d3Zoom.scale(), scale);

					return function(t) {
			      _this._update(iTranslate(t), iScale(t));
			    };
			  });
			};

			Zoom.prototype._displayPercentage = function(scale) {
			  var value;

			  value = Math.round(Math.log(scale) / Math.log(this.scale.max) * 100);
			  this.$info.text(value + "%");
			};

			Zoom.prototype._getScalesArray = function() {
			  var array = [],
			      scaleMaxLog = Math.log(this.scale.max);

			  for (var i = 0; i <= 10; i++) {
			    array.push(Math.pow(Math.E, 0.1 * i * scaleMaxLog));
			  }

			  return array;
			};

			Zoom.prototype._getNextScale = function(direction) {
			  var scaleSet = this.scale.set,
			      currentScale = this.d3Zoom.scale(),
			      lastShift = scaleSet.length - 1,
			      shift, temp = [];

			  if (this.scrolled) {

			    for (shift = 0; shift <= lastShift; shift++) {
			      temp.push(Math.abs(scaleSet[shift] - currentScale));
			    }

			    shift = temp.indexOf(Math.min.apply(null, temp));

			    if (currentScale >= scaleSet[shift] && shift < lastShift) {
			      shift++;
			    }

			    if (direction == "out" && shift > 0) {
			      shift--;
			    }

			    this.scrolled = false;

			  } else {

			    shift = this.scale.currentShift;

			    if (direction == "out") {
			      shift > 0 && shift--;
			    } else {
			      shift < lastShift && shift++;
			    }
			  }

			  this.scale.currentShift = shift;

			  return scaleSet[shift];
			};
			// example data from server		


			function Datamap() {
				map.id = 'map_container';		// Изменяем id у карты
				load_circle.style.display = "none"

				this.$container = $("#map_container");
				this.instance = new Datamaps({
				// projection: 'mercator',
			    fills: { defaultFill: "#707070" },
			    data: dataset,
			    geographyConfig: {
			      borderColor: '#DEDEDE',
			      borderWidth: '0px',
			      highlightBorderWidth: 1,
			      // don't change color on mouse hover
			      highlightFillColor: function(geo) {
			        return geo['fillColor'] || '#707070';		// Меняет заливку у страны, у которой нет значения
			      },
			      // Меняет цвет границы наведенной страны
			      highlightBorderColor: '#B7B7B7',
			      // show desired information in tooltip
			      popupTemplate: function(geo, data) {
			        // don't show tooltip if country don't present in dataset
			        if (!data) { return ; }
			        // tooltip content
			        return ['<div class="hoverinfo" style="background-color: #1e1a1a; border: 0px solid !important; box-shadow: 0 0 0 0; opacity: 0.9; color: #EEEEEE !important; text-transform: uppercase; height: 33px; font-family: "montserrat", sans-serif; 	font-size: 12px; font-weight: 500; line-height: 1.5;">',
			                '<div style="padding-top: 2px; padding-left: 6px; padding-right: 6px"><span>', geo.properties.name, '</span>',
			                '<br><span style="margin-top: 2px; display: block;">', data.numberOfThings.toLocaleString(), '</span></div>',
			                '</div>'].join('');
			      	}
			  	},
			    element: this.$container.get(0),
			    done: this._handleMapReady.bind(this)
				});

				
			}

			Datamap.prototype._handleMapReady = function(datamap) {
				this.zoom = new Zoom({
			  	$container: this.$container,
			  	datamap: datamap
			  });
			}

			new Datamap();
			// DATAMAP END
			// DATAMAP END
			// DATAMAP END

			// Передвежение ползунка слайдера. Смена позиции числа над слайдером и загрузка данных по конкретному году
			slider.oninput = function(){
				let data_text_start = document.getElementsByClassName('data_text_start')[0]
	    		let data_text_end = document.getElementsByClassName('data_text_end')[0]
	    		datepicker.value = 'Select Date'
	    		min_progress = 10000000000000;
	    		max_progress = 0;
				slider_ready = 1
				// console.log('arr_for_data');
				// console.log(arr_for_data);
				dataset = {}
				if(slider_container.className == 'slider_container_covid'){	 // Если ползунок по коронавирусу, то...
					let today = new Date(max_date_covid-((max_date_covid-min_date_covid) / (3600*1000*24)-this.value)*86400000) // 86400000 - это милиссикунды в одном дне, мы вычитаем кол-во дней * на 86400000
					let date_over_progress_bar = today.getMonth()+1+'/'+today.getDate()+'/'+String(date.getFullYear()).slice(2);
					num_over_slider.innerHTML = date_over_progress_bar;
					num_over_slider.style.left = (100 / (this.max - this.min + 1) - ((100 / (this.max - this.min + 1) * (this.max - this.min) - 95.8) / (this.max - this.min))) * ((this.max - this.min) - (this.max - this.value))  + "%";		// Если захочешь разобраться то тоби пызда, а вообще тут все довольно просто, надо просто вникнуть, если что 95.8 это проценты у left  (при 95.8% наше число над прогрес баром принимает крайнее правое значение)

					dp_v = date_over_progress_bar
					let dp_v_replace = dp_v.split('/')
	    			max_date_datepicker = new Date('20'+dp_v_replace[2], parseInt(dp_v_replace[0])-1, dp_v_replace[1]); // дата, которую выбрали на календаре
	    			previous_max_date_datepicker = new Date(max_date_datepicker-86400000)    // Предыдущая дата, по сравнению с max_date_datepicker
					if(title_category.innerHTML == 'New cases for current date' || title_category.innerHTML == 'New deaths for current date' || title_category.innerHTML == 'New recovered cases for current date'){
						click_data_covid('undefined', 2)
					}else{
						click_data_covid('undefined', 1)
					}
				}else{
					num_over_slider.innerHTML = this.value;
					arr_for_data = dict[this.value]
	  				num_over_slider.style.left = (100 / (this.max - this.min + 1) - ((100 / (this.max - this.min + 1) * (this.max - this.min) - 96.6) / (this.max - this.min))) * ((this.max - this.min) - (this.max - this.value))  + "%";		// Если захочешь разобраться то тоби пызда, а вообще тут все довольно просто, надо просто вникнуть, если что 96.6 это проценты у left  (при 96.6% наше число над прогрес баром принимает крайнее правое значение)
					
					for (let i = 0; i < arr_for_data.length; i++) {		// Если страна из первого массива есть в списке не отображающихся стран, то она удаляется из 1-го массива
						for (let ndc of not_displayed_countries) {
							if(arr_for_data[i][0] == ndc){
								arr_for_data.splice(i, 1);
							}
						}
					}

	  		
	  				for(let elem_arr of arr_for_data) {
				  		if(elem_arr[1] > max_progress){
				  			max_progress = elem_arr[1]
				  		}
				  		if(elem_arr[1] < min_progress){
				  			min_progress = elem_arr[1]	
				  		}
				  	}

				  	data_text_start.innerHTML = min_progress.toLocaleString()
					data_text_end.innerHTML = max_progress.toLocaleString()

	  				// We need to colorize every country based on "numberOfWhatever"
					// colors should be uniq for every value.
					// For this purpose we create palette(using min/max series-value)
					var onlyValues = arr_for_data.map(function(obj){ return obj[1]; });
					var minValue = Math.min.apply(null, onlyValues);
					var maxValue = Math.max.apply(null, onlyValues);
					var averageValue = (maxValue + minValue) / 2;

					// create color palette function
					// color can be whatever you wish
					if(random_gradient_arr[random_gradient].length == 3){
						var paletteScale = d3.scale.linear()
						.domain([minValue, averageValue, maxValue])
						.range(random_gradient_arr[random_gradient]); // color
					}else{
						var paletteScale = d3.scale.linear()
						.domain([minValue, maxValue])
						.range(random_gradient_arr[random_gradient]); // color
					}
					
					// fill dataset in appropriate format
	  				arr_for_data.forEach(function(item){ //
					  // item example value ["USA", 70]
					  let iso = item[0];
					  let value = item[1];
					  dataset[iso] = { numberOfThings: value, fillColor: paletteScale(value) };
					});
					//Удаление карты
					if(slider_ready){
						map.innerHTML = "";
						slider_ready = 0;
					}		
					new Datamap();	
				}		
			}

			// Загружается вся инфа по конкретному индикатору за все года
			function load_all_data(iscorona=0){
				try{
					x_lad.abort()		// прерывает запрос
				}
				catch{}
				let country_id;
				//slider.className = 'slider_load'
				let max_in_arr;
				let min_in_arr;
				let min_max_value_arr = []
				dict = {}
				let arr = []
				let n = 0
	    		x_lad = new XMLHttpRequest();
	    		if(iscorona == 0){
		    		x_lad.open("GET", "http://api.worldbank.org/v2/country/all/indicator/"+indicator+"?per_page=18000&format=json");
		    		x_lad.send();
		    		x_lad.onload = function() {
			    		if (x_lad.status != 200) {
						  	// обработать ошибку
						  	alert( x_lad.status + ': ' + x_lad.statusText ); // пример вывода: 404: Not Found
						} else {
							let r = JSON.parse(x_lad.response)
							// console.log('indicator: ');
							// console.log(indicator);
							let iso = r[1][0]['countryiso3code']
							for (let a = 0; a < r[0]['total']; a++) {
								if(typeof dict[r[1][a]['date']] !== "undefined"){		// Если у словаря есть значение (Если словарь создался), то 
									if(r[1][a]['value'] !== null){		// Если значение не равно null, то
										if(dict[r[1][a]['date']] == 'undefined'){
											dict[r[1][a]['date']] = []
										}
										arr.push(dict[r[1][a]['date']])
										if(!not_country.includes(r[1][a]['country']['id'])){
											if(n > 2){
												arr[0].push([r[1][a]['countryiso3code'], r[1][a]['value']])
				            					dict[r[1][a]['date']] = arr[0]
											}else{
												arr.push([r[1][a]['countryiso3code'], r[1][a]['value']])
				            					dict[r[1][a]['date']] = arr
											}
										}
									}
								}else{		// Если у словаря нет значения (Если словарь ен создался), то
									n = 0
									dict[r[1][a]['date']] = 'undefined'
								}
								arr = []
		   						n++
							}
						}
						
						for (let i = 1960; i < year+1; i++) {
							if(dict[i] !== 'undefined' && typeof dict[i] !== "undefined"){
								if(dict[i][0].length == false){	// Убираем неизвестно откуда появившиеся пустые массивы в начале "значения" у ключа
									dict[i] = dict[i].slice(1)
								}						
								min_max_value_arr.push(i)
							}
						}

						// console.log('dict done');
						// console.log(dict);

						max_in_arr = min_max_value_arr.slice(-1)
						min_in_arr = min_max_value_arr.slice(0, 1)

						min_num.innerHTML = min_in_arr
						max_num.innerHTML = max_in_arr
						slider.min = min_in_arr
						slider.max = max_in_arr
						slider.value = max_in_arr
						slider.disabled = '' // включается слайдер
						num_over_slider.innerHTML = max_in_arr
						slider_container.className = 'slider_container'

						//slider.className = 'slider'
						slider_loader.style.display = 'none'
					}
				}else{
					slider_container.className = 'slider_container_covid'
					//slider.className = 'slider'
					slider_loader.style.display = 'none'
					min_num.innerHTML = '1/23/20'
					max_num.innerHTML = month+'/'+day+'/'+String(year).slice(2) // сегодняшняя дата в формате month/day/year
					slider.min = 0
					slider.max = (max_date_covid-min_date_covid) / (3600*1000*24) // разница дней между сегодняшней датой и 1/23/20
					slider.value = slider.max
					slider.disabled = '' // включается слайдер
					num_over_slider.innerHTML = month+'/'+day+'/'+String(year).slice(2)

				}
			}

			function random_gradient_button(isdatepicker=0){
				dataset = {}
				let options_tab = document.getElementsByClassName('option_tab')
				let data_text_start = document.getElementsByClassName('data_text_start')[0]
	    		let data_text_end = document.getElementsByClassName('data_text_end')[0]
				let pre_pandom_gradient = random_gradient
				let option_tab_onclick = document.getElementsByClassName('option_tab option_tab_onclick')[0]
	
				if(!isdatepicker){	// Если данные не при загрузке календаря
					random_gradient = getRandomInt(random_gradient_arr.length)
					while (random_gradient_arr[random_gradient] == random_gradient_arr[pre_pandom_gradient]) {
						random_gradient = getRandomInt(random_gradient_arr.length)
					}
					set_random_gradient_arr()
				}
				option_tab_onclick.style.color = random_gradient_arr[random_gradient][0]
				
				// красится option_tab
    			if(option_tab_onclick.id == 'covid'){
					for(let option_tab of options_tab){
						if(option_tab.innerHTML == option_tab_onclick.innerHTML){
							if(option_tab.className != 'option_tab option_tab_onclick'){
								option_tab.className += ' option_tab_onclick'; 
							}			
							option_tab.style.color = random_gradient_arr[random_gradient][0] 	// красится option_tab, Если id у option_tab == "covid"
						}
					}
				}else{
					for(let option_tab of options_tab){
						if(option_tab.id == option_tab_onclick.id){
							if(option_tab.className != 'option_tab option_tab_onclick'){
								option_tab.className += ' option_tab_onclick'; 
							}			
							option_tab.style.color = random_gradient_arr[random_gradient][0] 	// красится option_tab, Если id у option_tab не "covid"
						}
					}
				}
				

				for (let i = 0; i < arr_for_data.length; i++) {		// Если страна из первого массива есть в списке не отображающихся стран, то она удаляется из 1-го массива
					for (let ndc of not_displayed_countries) {
						if(arr_for_data[i][0] == ndc){
							arr_for_data.splice(i, 1);
						}
					}
				}
				for(let elem_arr of arr_for_data) {
			  		if(elem_arr[1] > max_progress){
			  			max_progress = elem_arr[1]
			  		}
			  		if(elem_arr[1] < min_progress){
			  			min_progress = elem_arr[1]	
			  		}
			  	}
			  	data_text_start.innerHTML = min_progress.toLocaleString()
			  	data_text_end.innerHTML = max_progress.toLocaleString()

				var onlyValues = arr_for_data.map(function(obj){ return obj[1]; });
				var minValue = Math.min.apply(null, onlyValues);
				var maxValue = Math.max.apply(null, onlyValues);
				var averageValue = (maxValue + minValue) / 2;

				// create color palette function
				// color can be whatever you wish
				if(random_gradient_arr[random_gradient].length == 3){
					var paletteScale = d3.scale.linear()
					.domain([minValue, averageValue, maxValue])
					.range(random_gradient_arr[random_gradient]); // color
				}else{
					var paletteScale = d3.scale.linear()
					.domain([minValue, maxValue])
					.range(random_gradient_arr[random_gradient]); // color
				}
				
				// fill dataset in appropriate format
  				arr_for_data.forEach(function(item){ //
				  // item example value ["USA", 70]
				  let iso = item[0];
				  let value = item[1];
				  dataset[iso] = { numberOfThings: value, fillColor: paletteScale(value) };
				});
				//Удаление карты
				map.innerHTML = "";

				new Datamap()

			}
			// Кнопка "random_category", загружается рандомная категория из списка
			function random_category(){
				let options_tab = document.getElementsByClassName('option_tab')
				let elems_arr = []

				for(let option_tab of options_tab){
					elems_arr.push(option_tab.id)
				}

				let random = getRandomInt(elems_arr.length)

				if(elems_arr[random] == 'covid'){
					elems_arr = []
					for(let elem of covid_data_for_today){
						elems_arr.push(elem)
					}
					for(let elem of covid_historical_data){
						elems_arr.push(elem)
					}
					random = getRandomInt(elems_arr.length)
					indicator_random_bttn = elems_arr[random];
					click_data_covid('undefined', -1)
				}else{
					id = elems_arr[random];
					click_data()
				}
				
			}

			// Смена позиции ползунка (указателя) прогресc бар
			function progress_bar_switch(){
				let progress_bar = document.getElementsByClassName('progress_bar')[0]
				let start_num = document.getElementsByClassName('data_text_start')[0]
				let end_num = document.getElementsByClassName('data_text_end')[0]
				let elem = event.target
				let numberOfThings = elem.dataset.info
				if(typeof numberOfThings != "undefined"){
					progress_bar.style.display = 'block';
					let obj = JSON.parse(numberOfThings);
					let num = obj['numberOfThings']
					progress_bar.style.width = (num - min_progress) / (max_progress - min_progress) * 100 + '%'
				}else{
					progress_bar.style.display = 'none';
				}
			}
	    	// Поиск по словам
	    	function search_for_key(){
	    		let categories_inner = document.getElementsByClassName("categories_inner")[0]
	    		let input = document.getElementById("search_input")
	    		let bg = document.getElementById("bg_for_search_inner_container")
	    		let container = document.getElementById("search_inner_container")
	    		let input_arr = input.value.split(' ')	
	    		for (let space = 0; space < input_arr.length; space++) {	// проверка на пустые значения и пробелы
	    			if(input_arr[space] == "" || input_arr[space] == " "){
	    				input_arr.splice(space, 1);
	    			}
	    		}
	    		let not_include = [',', '.', '(', ')']
	    		//console.log(input_arr);
	    		data_alphabet_all.sort()
	    		console.log(data_alphabet_all);

	    		container.innerHTML = "";
	    		container.style.height = "0px";
				bg.style.height = "1px";
				bg.style.paddingTop = '0px';
				categories_inner.style.height = "728px";
	    		categories_inner.style.marginTop = "1px";
	    		for (let i = 0; i < data_alphabet_all.length; i++) {
	    			let new_a = []
	    			let b;
	    			let c = 0;
	    			let a = data_alphabet_all[i][0].split(' ')	

	    			for (let w = 0; w < a.length; w++) {
	    				b = a[w].toLowerCase()
	    				for(let s of not_include){
	    					if(b.slice(-1) == s){
	    						b = b.slice(0, -1)
	    					}
	    				}
	    				
	    				new_a.push(b)
	    			}
	    			for(let elem_i of input_arr){			
	    				if(new_a.includes(elem_i.toLowerCase())){		// Если два элемент есть в массиве, то ++, потом сравнивается 
	    					c++;
	    				}
	    			}
	    			if(c == input_arr.length){
	    				categories_inner.style.height = "568px";
	    				categories_inner.style.marginTop = "4px";
						bg.style.height = "154px";
						container.style.height = "146px";
						bg.style.paddingTop = '8px';
	    				var newDiv = document.createElement('div');
                        newDiv.innerHTML = data_alphabet_all[i][0];
                        newDiv.id = data_alphabet_all[i][1];
                        newDiv.className = 'option_tab'

                        if(data_alphabet_all[i][1] == 'covid'){		// Если id=='covid', то при клике вызывается функция click_data_covid
                        	newDiv.addEventListener("click", click_data_covid)
                        }else{	// Если id взято из Worldbank, то при клике вызывается функция click_data
                        	newDiv.addEventListener("click", click_data)
                        }

                        container.appendChild(newDiv);
	    			}	
	    		}
	    		if(input.value == ""){
					container.style.height = "0px";
					bg.style.height = "1px";
					bg.style.paddingTop = '0px';
					categories_inner.style.height = "728px";
	    			categories_inner.style.marginTop = "1px";
                }
	    	}

	    	// Функция прокрутки до нужного предложения, которое начинается с буквы, по которой кликнули
	    	function topscroll(){

	    		let scrollTop = 0
	    		let parent = event.target.parentElement.nextElementSibling.nextElementSibling
	    		let elems = parent.children
	    		for(let elem of elems){
	    			if(elem.innerHTML[0].toUpperCase() == event.target.innerHTML.toUpperCase()){
	    				$(parent).scrollTop(scrollTop);
	    				break;
	    			}else{
	    				scrollTop += elem.offsetHeight // Плюсуется полная высота элемента (вместе с отступами и со всем)
	    			}
	    		}
	    	}

	    	// Функция открытия меню, при клике на блок
	    	function menu(){
	    		let next;
	    		let elem = event.target
	    		let change_css;
	    		if(elem.className == "category_bg"){
	    			change_css = elem.firstElementChild
	    			next = elem.nextElementSibling
	    		}else if(elem.className == "category_text_block"){
	    			change_css = elem;
	    			next = elem.parentElement.parentElement.nextElementSibling;
	    		}else{
	    			change_css = elem;
	    			next = elem.parentElement.nextElementSibling;
	    		}


	    		if(next.style.display == 'block'){
	    			next.style.display = 'none';
	    			if(next.previousElementSibling.firstElementChild.className == "div_triangle"){
	    				next.previousElementSibling.firstElementChild.firstElementChild.className = "triangle_much"
	    			}else{
	    				next.previousElementSibling.firstElementChild.className = "triangle_less"
	    			}
	    		}else{
	    			next.style.display = "block";
	    			if(next.previousElementSibling.firstElementChild.className == "div_triangle"){
	    				next.previousElementSibling.firstElementChild.firstElementChild.className = "triangle_much_open"
	    			}else{
	    				next.previousElementSibling.firstElementChild.className = "triangle_less_open"
	    			}
	    			let letters_for_search = next.firstElementChild.children;
	    			let select_tab = next.firstElementChild.nextElementSibling.nextElementSibling.children
	    			let click_data_letters = []
	    			for (let s of select_tab) {
	    				if(!click_data_letters.includes(s.innerHTML[0].toLowerCase())){
	    					click_data_letters.push(s.innerHTML[0].toLowerCase())
	    				}	
	    			}
	    			for (let l of letters_for_search) {
	    				if(!click_data_letters.includes(l.innerHTML.toLowerCase())){
	    					l.className += " no_letter";
	    					l.removeEventListener('click', topscroll, false);
	    				}
	    			}
	    		}
	    	}
	    	// Берет данные из инпута (календарь)
    		function datepicker_value(New=0){
    			if(New){
    				dp_v = new Date(date.setHours(0, 0, 0, 0)-86400000)	// прошлая дата
    				dp_v =  dp_v.getMonth()+1+'/'+dp_v.getDate()+'/'+dp_v.getFullYear().toString().slice(-2)    // прошлая дата в формате m/d/y
    				previous_max_date_datepicker = new Date(max_date_covid-86400000-86400000)    // Позапрошлая дата, по сравнению с max_date_datepicker

    				click_data_covid('undefined', 2)
    			}else{
	    			dp_v = datepicker.value;
	    			let dp_v_replace = dp_v.split('/')
	    			max_date_datepicker = new Date('20'+dp_v_replace[2], parseInt(dp_v_replace[0])-1, dp_v_replace[1]); // дата, которую выбрали на календаре
	    			previous_max_date_datepicker = new Date(max_date_datepicker-86400000)    // Предыдущая дата, по сравнению с max_date_datepicker
	    			slider.value = (max_date_datepicker-min_date_covid) / (3600*1000*24) // разница дней между сегодняшней датой и 1/23/20
	    			num_over_slider.innerHTML = dp_v
	    			num_over_slider.style.left = (100 / (slider.max - slider.min + 1) - ((100 / (slider.max - slider.min + 1) * (slider.max - slider.min) - 95.8) / (slider.max - slider.min))) * ((slider.max - slider.min) - (slider.max - slider.value))  + "%";	// смена позиции текста над слайдером
	    			if(title_category.innerHTML == 'New cases for current date' || title_category.innerHTML == 'New deaths for current date' || title_category.innerHTML == 'New recovered cases for current date'){	// Если категория равна ... , то мы передаем значение "2", для того чтобы понять, когда надо вычитать дату для этих категорий(как то так объяснил)
	    				click_data_covid('undefined', 2)
	    			}else{
	    				click_data_covid('undefined', 1)
	    			}	
	    		}
    		}
	    	// Загрузка данных для короны
	    	function click_data_covid(event, history=0){
	    		let disabledDates = [year+'-'+month+'-'+previous_day]		// Даты, которые будут дезактивированы (в нашем случае, это - предыдущий день)
	    		let canada = 0;
	    		let ifcanada = 0;
	    		let australia = 0;
	    		let ifaustralia = 0;
	    		let china = 0;
	    		let ifchina = 0;
	    		let iscorona = 0;
	    		let isdatepicker = 0;
	    		let do_we_need_a_datepicker = 0
	    		let load_coronavirus_data_from_history_data = 0
	    		let previous_data_format_datepicker;
	    		let indicator;

	    		// ЗАГРУЗКА СРАЗУ CASES НА ВКЛАДКЕ КОРОНА
	    		if(category != 'coronavirus' && ctg_and_indicator[0] != 'covid-19' && history != -1){		// Делаем загрузку категории "cases", при заходе на вкладку "корона"
	    			var elem = event.target
	    		}
	    		let options_tab = document.getElementsByClassName('option_tab')
	    		let data_text_start = document.getElementsByClassName('data_text_start')[0]
	    		let data_text_end = document.getElementsByClassName('data_text_end')[0]
	    		let categories_text = document.getElementsByClassName('categories_text')[0]
	    		let slider_container = document.getElementById('slider_container')
	    		let num_over_slider = document.getElementById('num_over_slider')
	    		let min_max_nums = document.getElementById('min_max_nums')


	    		
	    		datepicker.style.display = 'none';
	    		slider_container.style.display = "none"
	    		slider_loader.style.display = "none"

	    		min_progress = 10000000000000;
	    		max_progress = 0;
	    		arr_for_data = []

	    		if(history > 0){	// Загрузка даты по предыдущим дням
	    			slider_container.style.display = "block"
	    			isdatepicker = 1
	    			datepicker.style.display = 'inline-block';
	    			if(month+'/'+day+'/'+String(year).slice(2) == dp_v){			// Если на календаре выбрали сегодняшнюю дату
	    				if(title_category.innerHTML == 'New cases for current date' || title_category.innerHTML == 'New deaths for current date' || title_category.innerHTML == 'New recovered cases for current date'){
	    					arr_for_data = arr_for_data_copy_covid
	    				}else{
	    					arr_for_data = arr_for_data_copy
	    				}		
	    			}else{
	    				previous_data_format_datepicker = previous_max_date_datepicker.getMonth()+1+'/'+previous_max_date_datepicker.getDate()+'/'+previous_max_date_datepicker.getFullYear().toString().slice(-2)
	    				if(history == 1){
							for (let i = 0; i < historical_covid_data.length; i++) {
								let province = historical_covid_data[i]['province']
								let hcd = historical_covid_data[i]['timeline'][indicator_for_history.toLowerCase()][dp_v]
								if(province == 'greenland'){
			    					arr_for_data.push(['GRL', hcd])
			    				}else if(province == 'french guiana'){
			    					arr_for_data.push(['GUF', hcd])
			    				}
			    				else if(province == 'new caledonia'){
			    					arr_for_data.push(['NCL', hcd])
			    				}else if(province == 'Falkland Islands (Malvinas)'){
			    					arr_for_data.push(['FLK', hcd])
			    				}else{
			    					// Складываем данные из провинций во едино по странам: Канада, Китай, Австралия
			    					if(historical_covid_data[i]['country'] == 'Canada') {
			    						ifcanada = 1
			    						canada += hcd

			    					}else if(ifcanada){			
			    						ifcanada = 0
			    						arr_for_data.push([dict_country_iso3_history_previous['Canada'], canada])
			    					}
			    					if(historical_covid_data[i]['country'] == 'China') {
			    						ifchina = 1						
			    						china += hcd
			    					}else if(ifchina){
			    						ifchina = 0
			    						arr_for_data.push([dict_country_iso3_history_previous['China'], china])
			    					}
			    					if(historical_covid_data[i]['country'] == 'Australia') {
			    						ifaustralia = 1
			    						australia += hcd
			    					}else if(ifaustralia){			
			    						ifaustralia = 0
			    						arr_for_data.push([dict_country_iso3_history_previous['Australia'], australia])
			    					}

			    					if(!ifcanada && !ifchina && !ifaustralia){
			    						arr_for_data.push([dict_country_iso3_history_previous[historical_covid_data[i]['country']], hcd])
			    					}
			    					
			    				}
			    			}
			    		}else if(history == 2){
			    			for (let i = 0; i < historical_covid_data.length; i++) {
								let province = historical_covid_data[i]['province']
								let hcd = historical_covid_data[i]['timeline'][indicator_for_history.toLowerCase()][dp_v]-historical_covid_data[i]['timeline'][indicator_for_history.toLowerCase()][previous_data_format_datepicker]
								if(hcd < 0){
									hcd = 0
								}
								if(province == 'greenland'){
			    					arr_for_data.push(['GRL', hcd])
			    				}else if(province == 'french guiana'){
			    					arr_for_data.push(['GUF', hcd])
			    				}
			    				else if(province == 'new caledonia'){
			    					arr_for_data.push(['NCL', hcd])
			    				}else if(province == 'Falkland Islands (Malvinas)'){
			    					arr_for_data.push(['FLK', hcd])
			    				}else{
			    					// Складываем данные из провинций во едино по странам: Канада, Китай, Австралия
			    					if(historical_covid_data[i]['country'] == 'Canada') {
			    						ifcanada = 1
			    						canada += hcd

			    					}else if(ifcanada){			
			    						ifcanada = 0
			    						arr_for_data.push([dict_country_iso3_history_previous['Canada'], canada])
			    					}
			    					if(historical_covid_data[i]['country'] == 'China') {
			    						ifchina = 1						
			    						china += hcd
			    					}else if(ifchina){
			    						ifchina = 0
			    						arr_for_data.push([dict_country_iso3_history_previous['China'], china])
			    					}
			    					if(historical_covid_data[i]['country'] == 'Australia') {
			    						ifaustralia = 1
			    						australia += hcd
			    					}else if(ifaustralia){			
			    						ifaustralia = 0
			    						arr_for_data.push([dict_country_iso3_history_previous['Australia'], australia])
			    					}

			    					if(!ifcanada && !ifchina && !ifaustralia){
			    						arr_for_data.push([dict_country_iso3_history_previous[historical_covid_data[i]['country']], hcd])
			    					} 				
			    				}
			    			}
			    			if(iff){
			    				console.log(arr_for_data);
			    				arr_for_data_copy_covid = arr_for_data
			    				iff = 0
			    			}
			    		}
		    		}
	    		}else{		// загрузка данных на сегодняшний день
	    			datepicker.value = ''
		    		for (let o = 0; o < options_tab.length; o++) {		// Убираем выделение у всех элементов, и выделяем элемент, по которому кликнули
		    			if(options_tab[o].className == "option_tab option_tab_onclick"){
		    				options_tab[o].className = "option_tab"
		    				options_tab[o].style.color = ''	// Убираем цвет на изначальный
		    				//elem.style.color = '#9A9A9A' 	удаление покраски в рандомный цвет при клике
		    			}
		    		}
		    		iff = 1


		    		// Приводим слайдер в нормальное положение
		    		slider.min = 0
		    		slider.max = (max_date_covid-min_date_covid) / (3600*1000*24) // разница дней между сегодняшней датой и 1/23/20
		    		num_over_slider.style.left = '96.6%'
		    		num_over_slider.innerHTML = slider.max
		    		min_num.innerHTML = slider.min
		    		max_num.innerHTML = slider.max
	    			slider.value = slider.max


		    		//elem.style.color = random_gradient_arr[random_gradient][0] покраска в рандомный цвет при клике

		    		// ЗАГРУЗКА СРАЗУ CASES НА ВКЛАДКЕ КОРОНА
		    		if(category == 'coronavirus'){	// Делаем загрузку категории "cases", при заходе на вкладку "корона"
		    			for(let opt_tab of options_tab){
		    				if(opt_tab.innerHTML == 'Total cases for today'){
		    					opt_tab.className += ' option_tab_onclick';
		    				}
		    			}
		    		}else if(ctg_and_indicator[0] == 'covid-19'){
		    			var indicator_covid = ctg_and_indicator[1].split("-").join(" ")
		    			indicator_covid = indicator_covid[0].toUpperCase() + indicator_covid.substring(1)
		    			for(let opt_tab of options_tab){
		    				if(opt_tab.innerHTML == indicator_covid){
		    					opt_tab.className += ' option_tab_onclick';
		    				}
		    			}
		    		}else if(history == -1){		// Если нажата кнопка "Random Category"
		    			for(let opt_tab of options_tab){
		    				if(opt_tab.innerHTML == indicator_random_bttn){
		    					opt_tab.className += ' option_tab_onclick';
		    				}
		    			}
		    		}else{
		    			elem.className += ' option_tab_onclick';
		    		}
		    		map.id = 'map_container_load';		// Изменяем id у карты
		    		load_circle.style.display = "block"
		    		

		    		// ЗАГРУЗКА СРАЗУ CASES НА ВКЛАДКЕ КОРОНА
		    		if(category == 'coronavirus'){	// Делаем загрузку категории "cases", при заходе на вкладку "корона"
		    			indicator = 'cases';
		    			title_category.innerHTML = 'Total cases for today'
		    		}else if(ctg_and_indicator[0] == 'covid-19'){
		    			indicator = covid_categories_longest[indicator_covid]
		    			title_category.innerHTML = indicator_covid
		    		}else if(history == -1){		// Если нажата кнопка "Random Category"
		    			indicator = covid_categories_longest[indicator_random_bttn]
		    			title_category.innerHTML = indicator_random_bttn
		    		}else{
		    			indicator = covid_categories_longest[elem.innerHTML]
		    			//indicator = elem.innerHTML.replace(/\s+/g, ''); // Заменяем пробелы в строке на ''
		    			//indicator = indicator[0].toLowerCase() + indicator.substring(1)		// Делаем первую букву маленькой
		    			title_category.innerHTML = elem.innerHTML;	
		    		}

		    		
		    		// Выводим название категории
		    		//console.log(elem);
					//console.log(category);
					
		    		if(categories_text.innerHTML == 'coronavirus'){		// Если текст элемента <div class="categories_text"></div> равен 'coronavirus', то мы делаем вывод, что у нас открыта вкладка коронавирус, и мы меняем title_region.innerHTML на...
		    			if(covid_data_for_today.indexOf(title_category.innerHTML) != -1){
		    				title_region.innerHTML = 'Coronavirus'
		    				title_region_span.innerHTML = ' (Source: Worldometers)'
		    			}else{
		    				title_region.innerHTML = 'Coronavirus'
		    				title_region_span.innerHTML = ' (Source: Johns Hopkins University)'
		    			}			
		    		}else if(ctg_and_indicator[0] == 'covid-19'){
		    			if(covid_data_for_today.indexOf(indicator_covid) != -1){
		    				title_region.innerHTML = 'Covid-19'
		    				title_region_span.innerHTML = ' (Source: Worldometers)'
		    			}else{
		    				title_region.innerHTML = 'Covid-19'
		    				title_region_span.innerHTML = ' (Source: Johns Hopkins University)'
		    			}	
		    		}else if(history == -1){		// Если нажата кнопка "Random Category"
		    			for(let option_tab of options_tab){
		    				if(option_tab.innerHTML == indicator_random_bttn){
		    					if(covid_data_for_today.indexOf(option_tab.innerHTML) != -1){
		    						title_region.innerHTML = option_tab.parentElement.parentElement.previousElementSibling.children[1].innerHTML
		    						title_region_span.innerHTML = ' (Source: Worldometers)'
		    					}else{
		    						title_region.innerHTML = option_tab.parentElement.parentElement.previousElementSibling.children[1].innerHTML
		    						title_region_span.innerHTML =' (Source: Johns Hopkins University)'
		    					}
		    					
		    				}
		    			}
		    		}else{
		    			for(let option_tab of options_tab){
		    				if(option_tab.innerHTML == elem.innerHTML){
		    					if(covid_data_for_today.indexOf(option_tab.innerHTML) != -1){
		    						title_region.innerHTML = option_tab.parentElement.parentElement.previousElementSibling.children[1].innerHTML
		    						title_region_span.innerHTML = ' (Source: Worldometers)'
		    					}else{
		    						title_region.innerHTML = option_tab.parentElement.parentElement.previousElementSibling.children[1].innerHTML
		    						title_region_span.innerHTML =' (Source: Johns Hopkins University)'
		    					}
		    					
		    				}
		    			}
		    			window.history.pushState(null, null, "/home/category/covid-19/"+title_category.innerHTML.toLowerCase().split(" ").join("-"))
		    		}
		    		
		    		
		    		

		    		if(ctg_and_indicator[0] == 'covid-19'){		// Если url содержит "covid-19", то:
		    			if(indicator_covid == 'Total cases for today' || indicator_covid == 'Total deaths for today' || indicator_covid == 'Total recovered cases for today'){	// Если url равен ... , то нам не нужен календарь
		    				do_we_need_a_datepicker = 0
		    			}else{	
		    				do_we_need_a_datepicker = 1
		    			}
		    			if(indicator_covid == 'New cases for current date' || indicator_covid == 'New deaths for current date' || indicator_covid == 'New recovered cases for current date'){
		    				load_coronavirus_data_from_history_data = 1
		    			}
		    			ctg_and_indicator = 'used'		// После того, как загрузилась карта по выбранному индикатору, то этой переменной присваивается значение: "used"
		    		}else if(category == 'coronavirus'){
		    			do_we_need_a_datepicker = 0
		    			category = 'coronavirus-loaded'		// после первого раза загрузки cases во вкладке /coronavirus, category меняется на 'coronavirus-loaded'
		    		}else if(history == -1){	// Если нажата кнопка "Random Category"
		    			if(indicator_random_bttn == 'Total cases for today' || indicator_random_bttn == 'Total deaths for today' || indicator_random_bttn == 'Total recovered cases for today'){    // Если elem.innerHTML равен ... , то нам не нужен календарь
		    				do_we_need_a_datepicker = 0
		    			}else{
		    				do_we_need_a_datepicker = 1
		    			}
		    			if(indicator_random_bttn == 'New cases for current date' || indicator_random_bttn == 'New deaths for current date' || indicator_random_bttn == 'New recovered cases for current date'){
		    				load_coronavirus_data_from_history_data = 1
		    			}
		    		}else{	// Если url не содержит "covid-19", то:
		    			if(elem.innerHTML == 'Total cases for today' || elem.innerHTML == 'Total deaths for today' || elem.innerHTML == 'Total recovered cases for today'){    // Если elem.innerHTML равен ... , то нам не нужен календарь
		    				do_we_need_a_datepicker = 0
		    			}else{
		    				do_we_need_a_datepicker = 1
		    			}
		    			if(elem.innerHTML == 'New cases for current date' || elem.innerHTML == 'New deaths for current date' || elem.innerHTML == 'New recovered cases for current date'){
		    				load_coronavirus_data_from_history_data = 1
		    			}
		    		}
		    		if ((indicator == 'cases' || indicator == 'deaths' || indicator == 'recovered') && do_we_need_a_datepicker){	
		    			iscorona = 1
		    			slider_container.style.display = "block"	
		    			slider_loader.style.display = 'block' // загрузка лоадер
		    			datepicker.style.display = 'inline-block';
		    			slider_container.className = 'slider_container_covid'
		    			min_max_nums.className = 'min_max_nums_covid'
		    			slider.className = 'slider_covid'
		    			indicator_for_history = indicator
		    			
						// Локализация datepicker 
						$.datepicker.regional['ru'] = {
							weekHeader: 'Не',
							dateFormat: 'm/d/y',
							firstDay: 1,
							isRTL: false,
							showMonthAfterYear: false,
							yearSuffix: ''
						};
						$.datepicker.setDefaults($.datepicker.regional['ru']);

						$(function(){
							$("#datepicker").datepicker({
								minDate: new Date(2020, 0, 23), // 23 января 2020 года 
								maxDate: 0, 
								beforeShowDay: function(date){			// Деактивируем (делаем неактивным) конкретную дату (кнопку)
							        var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
							        return [ disabledDates.indexOf(string) == -1 ]
							    }
						  });
						});
						// Конец календаря
						document.getElementById('datepicker').removeAttribute("disabled"); // Отключаем инпут
						if(!load_coronavirus_data_from_history_data){ // Если загружаются не категории: "New cases for current date", "New deaths for current date", "New recovered cases for current date"
							arr_for_data = JHUCSSE_data_dict[indicator]
						}else{
			    			indicator_for_history = indicator
			    			datepicker_value(1)
			    		}
		    		}else{
		    			for (let i = 0; i < covid_data.length; i++) {
	    					arr_for_data.push([covid_data[i]['countryInfo']['iso3'], covid_data[i][indicator]])
	    				}
		    		}	
	    			arr_for_data_copy = arr_for_data
	    		}

	    		random_gradient_button(isdatepicker)		// метод вызова рандом градиента, там же и из него создается карта
	    		if(iscorona){
	    			load_all_data(iscorona)
	    		}
	    		

	    		/*
    			for (let i = 0; i < arr_for_data.length; i++) {		// Если страна из первого массива есть в списке не отображающихся стран, то она удаляется из 1-го массива
					for (let ndc of not_displayed_countries) {
						if(arr_for_data[i][0] == ndc){
							arr_for_data.splice(i, 1);
						}
					}
				}
				console.log(arr_for_data);
	    		for(let elem_arr of arr_for_data) {
			  		if(elem_arr[1] > max_progress){
			  			max_progress = elem_arr[1]
			  		}
			  		if(elem_arr[1] < min_progress){
			  			min_progress = elem_arr[1]	
			  		}
		  		}

	    		data_text_start.innerHTML = min_progress.toLocaleString()
			  	data_text_end.innerHTML = max_progress.toLocaleString()
			  	//console.log(arr_for_data);

			  	// Datamaps expect data in format:
				// { "USA": { "fillColor": "#42a844", numberOfWhatever: 75},
				//   "FRA": { "fillColor": "#8dc386", numberOfWhatever: 43 } }
				dataset = {};

				// We need to colorize every country based on "numberOfWhatever"
				// colors should be uniq for every value.
				// For this purpose we create palette(using min/max series-value)
				var onlyValues = arr_for_data.map(function(obj){ return obj[1]; });
				var minValue = Math.min.apply(null, onlyValues);
				var maxValue = Math.max.apply(null, onlyValues);
				var averageValue = (maxValue + minValue) / 2;

				// create color palette function
				// color can be whatever you wish
				if(random_gradient_arr[random_gradient].length == 3){
					var paletteScale = d3.scale.linear()
					.domain([minValue, averageValue, maxValue])
					.range(random_gradient_arr[random_gradient]); // color
				}else{
					var paletteScale = d3.scale.linear()
					.domain([minValue, maxValue])
					.range(random_gradient_arr[random_gradient]); // color
				}
				// fill dataset in appropriate format
				arr_for_data.forEach(function(item){ //
				  // item example value ["USA", 70]
				  var iso = item[0];
				  var value = item[1];
				  dataset[iso] = { numberOfThings: value, fillColor: paletteScale(value) };
				});
				//Удаление карты
				map.innerHTML = "";

				new Datamap();
				*/
	    	}

	    	// Загрузка данных из API - World Bank Data
	    	function click_data(){
	    		document.getElementById('datepicker').setAttribute("disabled", "true");  // включаем инпут
	    		let options_tab = document.getElementsByClassName('option_tab')	
	    		let num_over_slider = document.getElementById('num_over_slider')    		
	    		let min_max_nums = document.getElementById('min_max_nums')
	    		
	    		slider.min = 1960
	    		slider.max = 2020
	    		num_over_slider.style.left = '96.6%'
	    		num_over_slider.innerHTML = slider.max
	    		min_num.innerHTML = slider.min
	    		max_num.innerHTML = slider.max
	    		slider.value = slider.max
	    		slider.disabled = 'disabled' // неактивный слайдер
	    		datepicker.style.display = 'none';	
	    		slider_container.style.display = 'block';

	    		slider_container.className = 'slider_container'
    			min_max_nums.className = 'min_max_nums'
    			slider.className = 'slider'

	    		arr_for_data = []

	    		let elem;

	    		map.id = 'map_container_load';		// Изменяем id у карты
	    		load_circle.style.display = "block"
	    		slider_loader.style.display = 'block'

	    		for (let option_tab of options_tab) {		// Убираем выделение у всех элементов, и выделяем элемент, по которому кликнули
	    			if(option_tab.className == "option_tab option_tab_onclick"){
	    				option_tab.className = "option_tab"
	    				option_tab.style.color = ''	// Убираем цвет на изначальный
	    			}
	    		}
	    		if(id == ""){		// Если кликнули по категории в меню
	    			elem = event.target;
	    			indicator = elem.id;
	    		}else{				// Если нажали кнопку "random category"
	    			elem = document.getElementById(id);
	    			indicator = id;
	    			console.log(elem);
	    			console.log(indicator);

	    		}
	    		id = "";
	
	    		elem.className += ' option_tab_onclick';   		
	    		
	    		let country_iso_2 = "";
	    		let country_name = "";
	    		let count = 0;
	    		let date = 2019;  // Год 
	    		min_progress = 10000000000000;
	    		max_progress = 0;
	    		let country_id;
	    		var x = new XMLHttpRequest();
	    		x.open("GET", "http://api.worldbank.org/v2/country/all/indicator/"+indicator+"?date="+date+"&per_page=300&format=json");
	    		x.send();
	    		x.onload = function(){
		    		if (x.status != 200) {
					  	// обработать ошибку
					  	alert( x.status + ': ' + x.statusText ); // пример вывода: 404: Not Found
					} else {
						//console.log(elem);
						//console.log(category);

						title_region.innerHTML = elem.parentElement.parentElement.previousElementSibling.children[1].innerHTML	// Дается название индикатора (title_category)
						for(let option_tab of options_tab){
							if(option_tab.id == elem.id){
								title_region.innerHTML = option_tab.parentElement.parentElement.previousElementSibling.children[1].innerHTML	// Дается название категории (title_region)
								title_region_span.innerHTML = ' (Source: Worldbank)'
							}
						}

						title_category.innerHTML = elem.innerHTML;
						history.pushState(null, null, "/home/category/"+title_region.innerHTML.toLowerCase().split(" ").join("-")+"/"+indicator)
						let r = JSON.parse(x.response)						
						for (var c = 0; c < r[0]['total']; c++) {
					  		count = 0;
					  		try{
						  		if (r[1][c]['value'] == null){		// если значение == null , то пропускаем 1 итерацию цикл
						  			continue;
						  		} else {
					  				if(!not_country.includes(r[1][c]['country']['id'])){
					  					
					  					if(r[1][c]['countryiso3code'] == ""){
					  						country_id = r[1][c]['country']['id']
					  					}else{
					  						country_id = r[1][c]['countryiso3code']
					  					}


					  					if(country_id == 'XKX'){
					  						country_name = '-99';
					  					}else{
					  						country_name = country_id
					  					}					  				
						  				country_value = r[1][c]['value']
						  				count = 1;
					  				}
					  			}
					  		} catch(e){
					  			break;
					  		}
					  		if(count){
					  			arr_for_data.push([country_name, country_value])		// Вставляется в массив стран для DATA имя страны и ее значение
					  		}		
					  	}

					  	random_gradient_button()		// метод вызова рандом градиента, там же и из него создается карта
						load_all_data()

					  	/*
					  	for (let i = 0; i < arr_for_data.length; i++) {		// Если страна из первого массива есть в списке не отображающихся стран, то она удаляется из 1-го массива
							for (let ndc of not_displayed_countries) {
								if(arr_for_data[i][0] == ndc){
									arr_for_data.splice(i, 1);
								}
							}
						}
						
					  	for(let elem_arr of arr_for_data) {
					  		if(elem_arr[1] > max_progress){
					  			max_progress = elem_arr[1]
					  		}
					  		if(elem_arr[1] < min_progress){
					  			min_progress = elem_arr[1]	
					  		}
					  	}
					  	data_text_start.innerHTML = min_progress.toLocaleString()
					  	data_text_end.innerHTML = max_progress.toLocaleString()

					  	
					  	
					  	//console.log(arr_for_data);

					  	// Datamaps expect data in format:
						// { "USA": { "fillColor": "#42a844", numberOfWhatever: 75},
						//   "FRA": { "fillColor": "#8dc386", numberOfWhatever: 43 } }
						dataset = {};

						// We need to colorize every country based on "numberOfWhatever"
						// colors should be uniq for every value.
						// For this purpose we create palette(using min/max series-value)
						var onlyValues = arr_for_data.map(function(obj){ return obj[1]; });
						var minValue = Math.min.apply(null, onlyValues);
						var maxValue = Math.max.apply(null, onlyValues);
						var averageValue = (maxValue + minValue) / 2;

						// create color palette function
						// color can be whatever you wish
						if(random_gradient_arr[random_gradient].length == 3){
							var paletteScale = d3.scale.linear()
							.domain([minValue, averageValue, maxValue])
							.range(random_gradient_arr[random_gradient]); // color
						}else{
							var paletteScale = d3.scale.linear()
							.domain([minValue, maxValue])
							.range(random_gradient_arr[random_gradient]); // color
						}
						// fill dataset in appropriate format
						arr_for_data.forEach(function(item){ //
						  // item example value ["USA", 70]
						  var iso = item[0];
						  var value = item[1];
						  dataset[iso] = { numberOfThings: value, fillColor: paletteScale(value) };
						});
						//Удаление карты
						map.innerHTML = "";

						new Datamap();
						*/
					}
				}
	    	}
	    </script>
	</body>
</html>